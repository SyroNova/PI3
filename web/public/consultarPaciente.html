<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ElectroMed — Consultar Paciente</title>
  <link rel="icon" href="./assets/logo-electromed.png" type="image/png" />
  <link rel="stylesheet" href="./styles/base.css" />
  <link rel="stylesheet" href="./styles/consultarPaciente.css" />
</head>
<body>
  <!-- Topbar unificada -->
  <div class="app-topbar" role="banner">
    <div class="app-topbar__left">
      <span id="today" class="app-topbar__date">Hoy</span>
      <span class="app-topbar__sep">•</span>
      <span id="time" class="app-topbar__time">00:00</span>
    </div>
    <div>
      <button class="app-topbar__logout" data-action="toggle-theme" aria-pressed="false" title="Cambiar tema">☀️</button>
      <button class="app-topbar__logout" aria-label="Configuración" onclick="window.location.href='config.html'" title="Configuración">
        <span class="app-topbar__logout-icon">⚙️</span>
        
      </button>
      <button class="app-topbar__logout" aria-label="Cerrar sesión" onclick="window.location.href='index.html'" title="Cerrar sesión" style="margin-left:8px;">
        
        <span class="app-topbar__logout-label">Salir</span>
      </button>
    </div>
  </div>

  <main class="consultar-paciente">
    <!-- Cabecera centrada -->
    <header class="main-header">
      
      <h1 class="main-title">Consulta de Paciente</h1>
      <p class="main-subtitle">Revisa información y registra resultados</p>
    </header>

    <!-- Información del paciente con avatar -->
    <section class="patient-info patient-info--visual">
      <div class="patient-info__top">
        
        <div>
          <h2>Información del Paciente</h2>
        </div>
      </div>
      <div class="info-grid">
        <div class="info-item"><strong>Nombre:</strong> <span id="nombre-paciente"></span></div>
        <div class ="info-item"><strong>Estado:</strong> <span id="estado-paciente"></span></div>
        <div class="info-item"><strong>Edad:</strong> <span id="edad-paciente"></span></div>
        <div class="info-item"><strong>Sexo:</strong> <span id="sexo-paciente"></span></div>
        <div class="info-item"><strong>Diagnóstico:</strong> <span id="diagnostico-paciente"></span></div>
        <div class="info-item"><strong>Fecha de ingreso:</strong> <span id="fecha-ingreso"></span></div>
      </div>
    </section>

    <!-- Registro de resultados de electrolitos visual mejorado -->
    <section class="registro-electrolitos registro-electrolitos--visual">
      <h2><span style="color:#3b82f6;"></span> Registro de Resultados de Electrolitos</h2>
      <form id="form-electrolitos" autocomplete="off" class="electro-form">
        <div class="form-grid">
          <div class="field field--full">
            <label for="fecha-examen">Fecha del examen</label>
            <input type="date" id="fecha-examen" name="fecha-examen" required />
          </div>
          
          <!-- Panel Básico (Obligatorio) -->
          <div class="field">
            <label for="sodio">Sodio (Na⁺) *</label>
            <input type="number" step="0.01" id="sodio" name="sodio" placeholder="135 - 145 mEq/L" required />
            <small class="rango" id="rango-sodio"></small>
          </div>
          <div class="field">
            <label for="potasio">Potasio (K⁺) *</label>
            <input type="number" step="0.01" id="potasio" name="potasio" placeholder="3.5 - 5.0 mEq/L" required />
            <small class="rango" id="rango-potasio"></small>
          </div>
          <div class="field">
            <label for="cloro">Cloro (Cl⁻) *</label>
            <input type="number" step="0.01" id="cloro" name="cloro" placeholder="98 - 106 mEq/L" required />
            <small class="rango" id="rango-cloro"></small>
          </div>
          <div class="field">
            <label for="bicarbonato">Bicarbonato (HCO₃⁻) *</label>
            <input type="number" step="0.01" id="bicarbonato" name="bicarbonato" placeholder="22 - 28 mEq/L" required />
            <small class="rango" id="rango-bicarbonato"></small>
          </div>
          
          <!-- Panel Extendido (Opcional) -->
          <div class="field">
            <label for="calcio">Calcio (Ca²⁺)</label>
            <input type="number" step="0.01" id="calcio" name="calcio" placeholder="8.5 - 10.5 mg/dL" />
            <small class="rango" id="rango-calcio"></small>
          </div>
          <div class="field">
            <label for="magnesio">Magnesio (Mg²⁺)</label>
            <input type="number" step="0.01" id="magnesio" name="magnesio" placeholder="1.7 - 2.2 mg/dL" />
            <small class="rango" id="rango-magnesio"></small>
          </div>
          <div class="field">
            <label for="fosforo">Fósforo (P, fosfato)</label>
            <input type="number" step="0.01" id="fosforo" name="fosforo" placeholder="2.5 - 4.5 mg/dL" />
            <small class="rango" id="rango-fosforo"></small>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="btn-submit btn-submit--visual">Guardar resultado</button>
          </div>
        </div>
      </form>
      <div id="alerta-electrolitos" style="margin-top:1rem;"></div>
    </section>

    <!-- seguimiento de Electrolitos visual mejorado -->
    <section class="seguimiento-electrolitos seguimiento-electrolitos--visual">
      <!-- Title color is controlled from CSS variables in consultarPaciente.css -->
      <h2>Seguimiento de Electrolitos</h2>
      <!-- Timeline de resultados (llenado por JS) -->
      <div id="timeline-electrolitos" class="timeline-container"></div>

      <!-- Gráfico de historial -->
      <div id="grafico-historial" class="grafico-container">
        <canvas id="historial-chart" width="800" height="320" aria-label="Historial de electrolitos"></canvas>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="./theme.js"></script>
  <script>
    // Fecha y hora en tiempo real
    function updateDateTime() {
      const now = new Date();
      document.getElementById('today').textContent =
        now.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
      document.getElementById('time').textContent =
        now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
    }
  setInterval(updateDateTime, 60000);
    updateDateTime();

    // Validación automática de rangos (actualizado con valores de tabla médica)
    const rangos = {
      sodio: { min: 135, max: 145, bajo: 'Hiponatremia', alto: 'Hipernatremia', unidad: 'mEq/L' },
      potasio: { min: 3.5, max: 5.0, bajo: 'Hipopotasemia (o hipocalemia)', alto: 'Hiperpotasemia (o hiperkalemia)', unidad: 'mEq/L' },
      cloro: { min: 98, max: 106, bajo: 'Hipocloremia', alto: 'Hipercloremia', unidad: 'mEq/L' },
      bicarbonato: { min: 22, max: 28, bajo: 'Acidosis metabólica', alto: 'Alcalosis metabólica', unidad: 'mEq/L' },
      calcio: { min: 8.5, max: 10.5, bajo: 'Hipocalcemia', alto: 'Hipercalcemia', unidad: 'mg/dL' },
      magnesio: { min: 1.7, max: 2.2, bajo: 'Hipomagnesemia', alto: 'Hipermagnesemia', unidad: 'mg/dL' },
      fosforo: { min: 2.5, max: 4.5, bajo: 'Hipofosfatemia', alto: 'Hiperfosfatemia', unidad: 'mg/dL' }
    };

    function validarElectrolito(id, valor) {
      const r = rangos[id];
      if (!r || valor === "") return "";
      valor = parseFloat(valor);
      if (isNaN(valor)) return "";
      if (valor < r.min) return `<span style='color:#ef4444;font-weight:600'>${r.bajo}</span> <span style='color:#dc2626'>(bajo)</span>`;
      if (valor > r.max) return `<span style='color:#ef4444;font-weight:600'>${r.alto}</span> <span style='color:#dc2626'>(alto)</span>`;
      return `<span style='color:#22c55e;font-weight:600'>✓ Normal</span>`;
    }

    ['sodio','potasio','cloro','bicarbonato','calcio','magnesio','fosforo'].forEach(id => {
      const input = document.getElementById(id);
      if (input) {
        input.addEventListener('input', () => {
          document.getElementById('rango-' + id).innerHTML = validarElectrolito(id, input.value);
        });
      }
    });

    document.getElementById('form-electrolitos').addEventListener('submit', function(e) {
      e.preventDefault();
      document.getElementById('alerta-electrolitos').innerHTML = '<span style="color:#22c55e">Resultado guardado</span>';
    });

    document.addEventListener("DOMContentLoaded", () => {
  // Información simulada de un paciente
  const paciente = {
    nombre: "Juan Pérez",
    edad: 45,
    sexo: "Masculino",
    diagnostico: "Hiperkalemia",
    fechaIngreso: "2025-10-18",
    estado: "Estable"
  };

  // Rellenar la información en la interfaz
  document.getElementById("nombre-paciente").textContent = paciente.nombre;
  document.getElementById("edad-paciente").textContent = paciente.edad;
  document.getElementById("sexo-paciente").textContent = paciente.sexo;
  document.getElementById("diagnostico-paciente").textContent = paciente.diagnostico;
  document.getElementById("fecha-ingreso").textContent = paciente.fechaIngreso;
  document.getElementById("estado-paciente").textContent = paciente.estado;

  // --- Historial clínico simulado ---
    const seguimientoElectrolitos = [
      {
        fecha: "2025-10-20",
        sodio: 140,
        potasio: 4.2,
        cloro: 102,
      },
      {
        fecha: "2025-10-21",
        sodio: 139,
        potasio: 4.1,
        cloro: 100,

      },
      {
        fecha: "2025-10-23",
        sodio: 141,
        potasio: 4.0,
        cloro: 103,
        estado: "Normal"
      }
    ];
    
    // Renderizar timeline visual
    const timeline = document.getElementById("timeline-electrolitos");
    if (timeline) {
      timeline.innerHTML = seguimientoElectrolitos.map(item => `
        <div class="timeline-item">
          <div class="timeline-date">${item.fecha}</div>
          <div class="timeline-values">
            <span>Na⁺: ${item.sodio} mEq/L</span> |
            <span>K⁺: ${item.potasio} mEq/L</span> |
            <span>Cl⁻: ${item.cloro} mEq/L</span>
          </div>
          <div class="timeline-status" style="color:#22c55e;font-weight:600;">
          </div>
        </div>
      `).join("");
    }
    });

    // Historial clinico del paciente simulado
    const seguimientoElectrolitos = [
      { fecha: '2025-10-20', sodio: 140, potasio: 4.2, cloro: 102, calcio: 9.2, bicarbonato: 24 },
      { fecha: '2025-10-21', sodio: 139, potasio: 4.1, cloro: 100, calcio: 9.0, bicarbonato: 23 },
      { fecha: '2025-10-23', sodio: 141, potasio: 4.0, cloro: 103, calcio: 9.1, bicarbonato: 25 },
      { fecha: '2025-10-25', sodio: 138, potasio: 4.3, cloro: 101, calcio: 9.3, bicarbonato: 26 },
      { fecha: '2025-10-27', sodio: 142, potasio: 4.2, cloro: 104, calcio: 9.4, bicarbonato: 27 }
    ];
    // Aquí puedes agregar código para graficar el historial clínico usando Chart.js
    const canvas = document.getElementById('historial-chart');
    if (canvas) {
      const ctx = canvas.getContext('2d');

      const labels = seguimientoElectrolitos.map(item => item.fecha);
      const sodioData = seguimientoElectrolitos.map(item => item.sodio);
      const potasioData = seguimientoElectrolitos.map(item => item.potasio);
      const cloroData = seguimientoElectrolitos.map(item => item.cloro);

      // elegir colores de texto/grid según el tema (intenta leer variables CSS, si existen)
      const themeAttr = document.documentElement.getAttribute('data-theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = themeAttr || (prefersDark ? 'dark' : 'light');
  // Read chart colors from CSS variables (centralized in consultarPaciente.css)
  const computed = getComputedStyle(document.documentElement);
  const cssChartText = (computed.getPropertyValue('--chart-text') || '').trim();
  const cssChartGrid = (computed.getPropertyValue('--chart-grid') || '').trim();
  // Final colors: prefer CSS variables when present, otherwise fallback per theme
  const finalTextColor = cssChartText || (theme === 'dark' ? '#E6F2FF' : '#0f172a');
  const finalGridColor = cssChartGrid || (theme === 'dark' ? 'rgba(255,255,255,0.06)' : 'rgba(2,6,23,0.06)');

      // crear gradientes suaves para cada serie (más 'movido' visualmente pero estable)
  // Use solid line colors (no large filled areas) and lighter styling for light mode
  const colorSodio = 'rgba(59,130,246,0.95)';
  const colorPotasio = 'rgba(16,185,129,0.9)';
  const colorCloro = 'rgba(99,102,241,0.9)';
  const colorCalcio = 'rgba(250,204,21,0.95)';
  const colorBicarb = 'rgba(234,88,12,0.9)';

  // Opciones para dar movimiento suave pero sin overshoot: tension moderada y cubicInterpolationMode 'monotone'
      const chartOpts = {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Sodio (mEq/L)',
              data: sodioData,
              borderColor: colorSodio,
              backgroundColor: 'transparent',
              borderWidth: 2.2,
              pointRadius: 2,
              pointHoverRadius: 5,
              fill: false,
              tension: 0.28,
              cubicInterpolationMode: 'monotone'
            },
            {
              label: 'Potasio (mEq/L)',
              data: potasioData,
              borderColor: colorPotasio,
              backgroundColor: 'transparent',
              borderWidth: 2.0,
              pointRadius: 2,
              pointHoverRadius: 5,
              fill: false,
              tension: 0.28,
              cubicInterpolationMode: 'monotone'
            },
            {
              label: 'Cloro (mEq/L)',
              data: cloroData,
              borderColor: colorCloro,
              backgroundColor: 'transparent',
              borderWidth: 2.0,
              pointRadius: 2,
              pointHoverRadius: 5,
              fill: false,
              tension: 0.28,
              cubicInterpolationMode: 'monotone'
            },
            {
              label: 'Calcio (mg/dL)',
              data: seguimientoElectrolitos.map(item => item.calcio),
              borderColor: colorCalcio,
              backgroundColor: 'transparent',
              borderWidth: 1.8,
              pointRadius: 2,
              pointHoverRadius: 4,
              fill: false,
              tension: 0.28,
              cubicInterpolationMode: 'monotone'
            },
            {
              label: 'Bicarbonato (mEq/L)',
              data: seguimientoElectrolitos.map(item => item.bicarbonato),
              borderColor: colorBicarb,
              backgroundColor: 'transparent',
              borderWidth: 1.8,
              pointRadius: 2,
              pointHoverRadius: 4,
              fill: false,
              tension: 0.28,
              cubicInterpolationMode: 'monotone'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: {
              position: 'top',
              labels: { color: finalTextColor }
            },
            title: {
              display: true,
              text: 'Historial Clínico de Electrolitos',
              color: finalTextColor,
              font: { size: 14, weight: '600' }
            },
            tooltip: {
              mode: 'nearest',
              intersect: false,
              backgroundColor: (theme === 'dark') ? 'rgba(0,0,0,0.75)' : 'rgba(255,255,255,0.95)',
              titleColor: finalTextColor,
              bodyColor: finalTextColor,
              borderColor: finalGridColor
            }
          },
          elements: {
            line: { tension: 0.36 },
            point: { radius: 3 }
          },
          animation: {
            duration: 900,
            easing: 'easeOutCubic'
          },
          scales: {
            x: { ticks: { color: finalTextColor }, grid: { color: finalGridColor } },
            y: { ticks: { color: finalTextColor }, grid: { color: finalGridColor }, beginAtZero: false }
          }
        }
      };

      // creamos el chart y lo exponemos para futuras actualizaciones
      window.historialChart = new Chart(ctx, chartOpts);

      // Live theme updates: when data-theme changes, re-read CSS variables and update chart colors
      const updateChartColorsFromCSS = () => {
        const computed2 = getComputedStyle(document.documentElement);
        const cssChartText2 = (computed2.getPropertyValue('--chart-text') || '').trim();
        const cssChartGrid2 = (computed2.getPropertyValue('--chart-grid') || '').trim();
        const themeAttr2 = document.documentElement.getAttribute('data-theme');
        const textColor = cssChartText2 || (themeAttr2 === 'dark' ? '#E6F2FF' : '#071033');
        const gridColor = cssChartGrid2 || (themeAttr2 === 'dark' ? 'rgba(255,255,255,0.06)' : 'rgba(2,6,23,0.06)');
        if (window.historialChart) {
          try {
            const ch = window.historialChart;
            if (ch.options && ch.options.plugins) {
              if (ch.options.plugins.legend) ch.options.plugins.legend.labels.color = textColor;
              if (ch.options.plugins.title) ch.options.plugins.title.color = textColor;
              if (ch.options.plugins.tooltip) {
                ch.options.plugins.tooltip.titleColor = textColor;
                ch.options.plugins.tooltip.bodyColor = textColor;
                ch.options.plugins.tooltip.borderColor = gridColor;
              }
            }
            if (ch.options && ch.options.scales) {
              if (ch.options.scales.x) {
                if (ch.options.scales.x.ticks) ch.options.scales.x.ticks.color = textColor;
                if (ch.options.scales.x.grid) ch.options.scales.x.grid.color = gridColor;
              }
              if (ch.options.scales.y) {
                if (ch.options.scales.y.ticks) ch.options.scales.y.ticks.color = textColor;
                if (ch.options.scales.y.grid) ch.options.scales.y.grid.color = gridColor;
              }
            }
            ch.update();
          } catch (err) {
            console.warn('Error updating chart colors:', err);
          }
        }
      };

      // Observe theme changes on the document element
      const themeObserver = new MutationObserver(muts => {
        for (const m of muts) {
          if (m.attributeName === 'data-theme') updateChartColorsFromCSS();
        }
      });
      themeObserver.observe(document.documentElement, { attributes: true });
      // apply once
      updateChartColorsFromCSS();
    }
  </script>
</body>
</html>






